<%
  const depth = Number.isFinite(comment?.depth) ? comment.depth : 0;
  const commentId = comment?.snowflake_id || '';
  const parentId = comment?.parentId || null;
  const canReply = canComment && depth + 1 < maxCommentDepth;
  const authorName = comment?.author || t('admin.common.anonymous');
  const commentAuthorColor =
    comment?.authorRole && comment.authorRole.color ? comment.authorRole.color : null;
  const authorAttr = authorName.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  const authorClasses = ['comment-author', 'user-handle'];
  const commentAuthorStyle =
    commentAuthorColor && commentAuthorColor.hasColor ? commentAuthorColor.style : '';
  const avatarSource =
    (typeof comment?.authorAvatar === 'string' && comment.authorAvatar) ||
    (comment?.authorRole && comment.authorRole.avatarUrl ? comment.authorRole.avatarUrl : null);
  const trimmedName = authorName.trim();
  const avatarInitial = trimmedName ? trimmedName.charAt(0).toUpperCase() : 'â€¢';
  if (comment?.isAdminAuthor) {
    authorClasses.push('comment-author--admin');
  }
  if (commentAuthorColor && commentAuthorColor.hasColor) {
    authorClasses.push('role-colored-text');
    authorClasses.push(commentAuthorColor.className);
  }
  const canEditOwn = ownCommentTokens && commentId && ownCommentTokens[commentId];
  const attachments = Array.isArray(comment?.attachments) ? comment.attachments : [];
  const hasAttachments = attachments.length > 0;
%>
<li
  id="comment-<%= commentId %>"
  class="comment"
  data-comment-id="<%= commentId %>"
  data-comment-depth="<%= depth %>"
  data-parent-id="<%= parentId || '' %>"
  data-author-name="<%= authorAttr %>"
  style="--comment-depth: <%= depth %>"
>
  <div class="comment-header">
    <div class="comment-avatar">
      <% if (avatarSource) { %>
        <img src="<%= avatarSource %>" alt="" loading="lazy" />
      <% } else { %>
        <span class="comment-avatar-initial"><%= avatarInitial %></span>
      <% } %>
      <span class="sr-only"><%= t('common.avatarOf', { user: authorName }) %></span>
    </div>
    <div class="comment-meta">
      <span class="comment-author-header user-handle-decorated">
        <strong class="<%= authorClasses.join(' ') %>" style="<%= commentAuthorStyle %>">
          <%= authorName %>
        </strong>
        <%- include('userBadges', {
          badges: comment?.authorBadges,
          listClass: ['comment-author-badges', 'user-handle-badges'],
          itemClass: ['comment-author-badge-item', 'user-handle-badge-item'],
          iconClass: ['comment-author-badge-icon', 'user-handle-badge-icon'],
          srOnlyClass: 'sr-only',
          ariaLabel: t('common.authorBadgesAria'),
        }) %>
        <% if (hasAttachments) { %>
          <span class="comment-attachment-flag" title="<%= t('comment.attachments.availableTitle') %>">
            ðŸ“Ž<span class="sr-only"><%= t('comment.attachments.availableSr') %></span>
          </span>
        <% } %>
      </span>
      <span>Â· <%= fmt.dateTime(comment.created_at) %></span>
      <% if (comment?.ipProfile) { %>
        <span>
          Â·
          <a class="comment-ip-profile" href="/profiles/ip/<%= comment.ipProfile.hash %>">
            Profil IP #<%= comment.ipProfile.shortHash %>
          </a>
        </span>
      <% } %>
    </div>
  </div>
  <div class="comment-body"><%= comment.body %></div>
  <% if (hasAttachments) { %>
    <div class="comment-attachments" data-comment-attachments>
      <ul class="comment-attachment-list">
        <% attachments.forEach((attachment) => { %>
          <% const attachmentLabel =
            typeof attachment?.originalName === 'string' && attachment.originalName
              ? attachment.originalName
            : t('comment.attachments.item'); %>
          <% const attachmentUrl = typeof attachment?.url === 'string' ? attachment.url : ''; %>
          <% const rawSize = Number.isFinite(attachment?.size)
            ? Number(attachment.size)
            : Number.parseInt(attachment?.size, 10); %>
          <% const formattedSize = !Number.isNaN(rawSize) && rawSize > 0
            ? Math.max(1, Math.round(rawSize / 1024))
            : null; %>
          <li class="comment-attachment-item">
            <% if (attachment.isImage && attachmentUrl) { %>
              <a
                class="comment-attachment-link comment-attachment-link--image"
                href="<%= attachmentUrl %>"
                download="<%= attachmentLabel %>"
              >
                <img
                  class="comment-attachment-thumb"
                  src="<%= attachmentUrl %>"
                  alt="<%= t('comment.attachments.previewAlt', { name: attachmentLabel }) %>"
                  loading="lazy"
                />
                <span class="comment-attachment-label"><%= attachmentLabel %></span>
              </a>
            <% } else if (attachmentUrl) { %>
              <a
                class="comment-attachment-link"
                href="<%= attachmentUrl %>"
                download="<%= attachmentLabel %>"
              >
                <span class="comment-attachment-icon" aria-hidden="true">ðŸ“„</span>
                <span class="comment-attachment-label"><%= attachmentLabel %></span>
              </a>
            <% } else { %>
              <span class="comment-attachment-label"><%= attachmentLabel %></span>
            <% } %>
            <% if (formattedSize) { %>
              <span class="comment-attachment-size"><%= formattedSize %>&nbsp;<%= t('common.size.kb') %></span>
            <% } %>
          </li>
        <% }); %>
      </ul>
    </div>
  <% } %>
  <% if (Array.isArray(comment.reactions) && comment.reactions.length) { %>
    <div class="comment-reactions" data-comment-reactions>
      <%- include('reactionBar', {
        target: 'comment',
        slug: page.slug_id,
        commentId: comment.snowflake_id,
        reactions: comment.reactions,
        formAction: `/wiki/${page.slug_id}/comments/${comment.snowflake_id}/reactions`,
        condensed: true
      }) %>
    </div>
  <% } %>
  <% if (canReply || canEditOwn) { %>
    <div class="comment-actions">
      <% if (canReply) { %>
        <button
          class="btn secondary comment-reply-button"
          type="button"
          data-reply-to="<%= commentId %>"
          data-reply-author="<%= authorAttr %>"
        >
          <%= t('common.actions.reply') %>
        </button>
      <% } %>
      <% if (canEditOwn) { %>
        <a class="btn secondary" data-icon="âœï¸" href="/wiki/<%= page.slug_id %>/comments/<%= commentId %>/edit">
          <%= t('common.actions.edit') %>
        </a>
        <form
          method="post"
          action="/wiki/<%= page.slug_id %>/comments/<%= commentId %>/delete"
          onsubmit="return confirm(<%= JSON.stringify(t('comment.edit.deleteConfirm')) %>);"
        >
          <%- include('csrf_field') %>
          <button class="btn danger" data-icon="ðŸ—‘ï¸" type="submit"><%= t('common.actions.delete') %></button>
        </form>
      <% } %>
    </div>
  <% } %>
  <% if (comment?.children && comment.children.length) { %>
    <ul class="comment-list comment-children">
      <% comment.children.forEach((child) => { %>
        <%- include('comment', {
          comment: child,
          page,
          canComment,
          ownCommentTokens,
          maxCommentDepth,
        }) %>
      <% }); %>
    </ul>
  <% } %>
</li>
