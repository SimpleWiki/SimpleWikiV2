<% title = t('account.security.title'); %>
<section class="card security">
  <header class="security__header">
    <h1 class="mt-0"><%= t('account.security.heading') %></h1>
    <p class="text-muted"><%= t('account.security.intro') %></p>
  </header>

  <section class="security__status">
    <h2><%= t('account.security.status.heading') %></h2>
    <% if (twoFactorEnabled) { %>
      <p class="badge badge--success"><%= t('account.security.status.enabled') %></p>
    <% } else { %>
      <p class="badge badge--warning"><%= t('account.security.status.disabled') %></p>
    <% } %>
    <dl class="security__stats">
      <div>
        <dt><%= t('account.security.status.recoveryLeft') %></dt>
        <dd><%= recoveryCodesRemaining %> / <%= recoveryCodesTotal %></dd>
      </div>
      <div>
        <dt><%= t('account.security.status.recoveryUsed') %></dt>
        <dd><%= recoveryCodesUsed %></dd>
      </div>
    </dl>
  </section>

  <section class="security__passkeys" data-passkeys-root>
    <h2><%= t('account.security.passkeys.heading') %></h2>
    <p class="text-muted"><%= t('account.security.passkeys.intro') %></p>
    <% if (Array.isArray(passkeys) && passkeys.length) { %>
      <ul class="security__passkeys-list">
        <% passkeys.forEach((passkey) => { %>
          <li class="security__passkey-item">
            <div class="security__passkey-meta">
              <strong><%= passkey.friendlyName %></strong>
              <% if (passkey.createdAtFormatted) { %>
                <div><%= t('account.security.passkeys.registeredAt') %> <%= passkey.createdAtFormatted %></div>
              <% } %>
              <% if (passkey.lastUsedFormatted) { %>
                <div>
                  <%= t('account.security.passkeys.lastUsed') %>
                  <%= passkey.lastUsedFormatted %>
                  <% if (passkey.lastUsedRelative) { %>
                    (<%= passkey.lastUsedRelative %>)
                  <% } %>
                </div>
              <% } %>
              <% if (passkey.deviceType) { %>
                <div>
                  <%= t('account.security.passkeys.deviceType') %> <%= passkey.deviceType %>
                  <% if (passkey.backedUp) { %>
                    â€” <%= t('account.security.passkeys.backedUp') %>
                  <% } %>
                </div>
              <% } else if (passkey.backedUp) { %>
                <div>Sauvegarde activÃ©e</div>
              <% } %>
            </div>
            <form
              method="post"
              action="/account/security/passkeys/<%= encodeURIComponent(passkey.id) %>/delete"
              class="inline-form security__passkey-actions"
            >
              <%- include('../partials/csrf_field') %>
              <button class="btn danger" data-icon="ðŸ—‘ï¸"><%= t('account.security.passkeys.delete') %></button>
            </form>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted"><%= t('account.security.passkeys.none') %></p>
    <% } %>
    <div class="security__passkeys-form">
      <label class="field">
        <span class="field__label"><%= t('account.security.passkeys.form.deviceLabel') %></span>
        <input type="text" data-passkey-label placeholder="<%= t('account.security.passkeys.form.devicePlaceholder') %>" />
      </label>
      <div class="form-actions">
        <button type="button" class="btn" data-passkey-register data-icon="ðŸ”">
          <%= t('account.security.passkeys.form.addButton') %>
        </button>
      </div>
      <p class="field__hint"><%= t('account.security.passkeys.form.hint') %></p>
    </div>
  </section>

  <section class="security__password">
    <h2><%= t('account.security.password.heading') %></h2>
    <form method="post" action="/account/security/password" class="security__form">
      <%- include('../partials/csrf_field') %>
      <div class="field">
        <label for="current-password"><%= t('account.security.password.current') %></label>
        <input
          id="current-password"
          name="currentPassword"
          type="password"
          autocomplete="current-password"
          required
        />
      </div>
      <div class="field">
        <label for="new-password"><%= t('account.security.password.new') %></label>
        <input
          id="new-password"
          name="newPassword"
          type="password"
          autocomplete="new-password"
          minlength="8"
          required
        />
        <p class="field__hint"><%= t('account.security.password.hint') %></p>
      </div>
      <div class="field">
        <label for="confirm-password"><%= t('account.security.password.confirm') %></label>
        <input
          id="confirm-password"
          name="confirmPassword"
          type="password"
          autocomplete="new-password"
          required
        />
      </div>
      <div class="form-actions">
        <button class="btn" data-icon="ðŸ”‘"><%= t('account.security.password.update') %></button>
      </div>
    </form>
  </section>

  <% if (!setup && !twoFactorEnabled) { %>
    <section class="security__actions">
      <h2><%= t('account.security.enable.heading') %></h2>
      <p>
        <%= t('account.security.enable.intro') %>
      </p>
      <button
        type="button"
        class="btn success"
        data-modal-open="modal-start-setup"
        data-icon="ðŸ”"
      >
        <%= t('account.security.enable.start') %>
      </button>
    </section>
  <% } %>

  <% if (setup) { %>
    <section class="security__setup">
      <h2><%= t('account.security.setup.heading') %></h2>
      <div class="security__setup-grid">
        <div class="security__qr">
          <% if (setup.qrDataUrl) { %>
            <img
              src="<%= setup.qrDataUrl %>"
              alt="<%= t('account.security.setup.qrAlt') %>"
              loading="lazy"
            />
          <% } else if (setup.otpauthUrl) { %>
            <p>
              <strong><%= t('account.security.setup.provisioningLabel') %></strong>
              <code class="security__code"><%= setup.otpauthUrl %></code>
            </p>
          <% } else { %>
            <p class="text-muted"><%= t('account.security.setup.fallback') %></p>
          <% } %>
        </div>
        <div class="security__instructions">
          <ol>
            <li><%= t('account.security.setup.instructions.one') %></li>
            <li><%= t('account.security.setup.instructions.two') %></li>
            <li><%= t('account.security.setup.instructions.three') %></li>
          </ol>
          <p>
            <strong><%= t('account.security.setup.secretLabel') %></strong>
            <code class="security__code"><%= setup.secret %></code>
          </p>
          <button
            type="button"
            class="btn secondary"
            data-modal-open="modal-setup-recovery"
          >
            <%= t('account.security.setup.viewCodes') %>
          </button>
        </div>
      </div>
      <form class="security__form" method="post" action="/account/security/enable">
        <%- include('../partials/csrf_field') %>
        <div class="field">
          <label for="totp-token"><%= t('account.security.setup.form.totpLabel') %></label>
          <input
            id="totp-token"
            name="token"
            type="text"
            inputmode="numeric"
            autocomplete="one-time-code"
            maxlength="6"
            required
            placeholder="123456"
            title="<%= t('account.security.setup.form.codeTitle') %>"
          />
        </div>
        <div class="form-actions">
          <button class="btn success" data-icon="âœ…"><%= t('account.security.setup.form.activate') %></button>
          <button
            type="button"
            class="btn link"
            data-modal-open="modal-cancel-setup"
          >
            <%= t('account.security.common.cancel') %>
          </button>
        </div>
      </form>
    </section>
  <% } %>

  <% if (twoFactorEnabled) { %>
    <section class="security__management">
      <h2><%= t('account.security.manage.heading') %></h2>
      <div class="security__management-actions">
        <button
          type="button"
          class="btn secondary"
          data-modal-open="modal-view-recovery"
        >
          <%= t('account.security.manage.viewCodes') %>
        </button>
        <button
          type="button"
          class="btn"
          data-modal-open="modal-regenerate-codes"
        >
          <%= t('account.security.manage.regenerate') %>
        </button>
        <button
          type="button"
          class="btn danger"
          data-modal-open="modal-disable-twofactor"
        >
          <%= t('account.security.manage.disable') %>
        </button>
      </div>
    </section>
  <% } %>

  <% if (!twoFactorEnabled && !setup) { %>
    <p class="text-muted"><%= t('account.security.disabledHint') %></p>
  <% } %>

  <% if (!setup && generatedRecoveryCodes && generatedRecoveryCodes.length) { %>
    <section class="security__notice">
      <h2><%= t('account.security.notice.heading') %></h2>
      <p>
        <%= t('account.security.notice.intro') %>
      </p>
      <div class="security__notice-actions">
        <button
          type="button"
          class="btn secondary"
          data-modal-open="modal-view-recovery"
        >
          <%= t('account.security.notice.view') %>
        </button>
        <a class="btn" href="/account/security/recovery-codes/download" download><%= t('account.security.common.download') %></a>
        <form
          method="post"
          action="/account/security/recovery-codes/acknowledge"
          class="inline-form"
        >
          <%- include('../partials/csrf_field') %>
          <button class="btn success" data-icon="âœ”ï¸"><%= t('account.security.notice.ack') %></button>
        </form>
      </div>
    </section>
  <% } %>
</section>

<dialog id="modal-start-setup" class="modal">
  <form method="post" action="/account/security/setup" class="modal__content">
    <%- include('../partials/csrf_field') %>
    <h2><%= t('account.security.enable.heading') %></h2>
    <p>
      <%= t('account.security.enable.modalIntro') %>
    </p>
    <div class="modal__actions">
      <button class="btn success" data-icon="ðŸ”"><%= t('account.security.enable.generate') %></button>
      <button type="button" class="btn link" data-modal-close><%= t('account.security.common.cancel') %></button>
    </div>
  </form>
</dialog>

<dialog id="modal-cancel-setup" class="modal">
  <form method="post" action="/account/security/cancel-setup" class="modal__content">
    <%- include('../partials/csrf_field') %>
    <h2><%= t('account.security.cancel.title') %></h2>
    <p><%= t('account.security.cancel.body') %></p>
    <div class="modal__actions">
      <button class="btn danger" data-icon="âœ–"><%= t('account.security.cancel.confirm') %></button>
      <button type="button" class="btn link" data-modal-close><%= t('account.security.common.back') %></button>
    </div>
  </form>
</dialog>

<dialog id="modal-setup-recovery" class="modal">
  <article class="modal__content">
    <h2><%= t('account.security.recovery.title') %></h2>
    <% if (setup && setup.recoveryCodes && setup.recoveryCodes.length) { %>
      <p><%= t('account.security.recovery.keepSafe') %></p>
      <ul class="security__recovery-list">
        <% setup.recoveryCodes.forEach(function (code) { %>
          <li><code class="security__code"><%= code %></code></li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted"><%= t('account.security.recovery.none') %></p>
    <% } %>
    <footer class="modal__actions">
      <a class="btn" href="/account/security/recovery-codes/download" download><%= t('account.security.common.download') %></a>
      <button type="button" class="btn link" data-modal-close><%= t('account.security.common.close') %></button>
    </footer>
  </article>
</dialog>

<dialog id="modal-view-recovery" class="modal">
  <article class="modal__content">
    <h2><%= t('account.security.recovery.available') %></h2>
    <% if (generatedRecoveryCodes && generatedRecoveryCodes.length) { %>
      <p><%= t('account.security.recovery.latest') %></p>
      <ul class="security__recovery-list">
        <% generatedRecoveryCodes.forEach(function (code) { %>
          <li><code class="security__code"><%= code %></code></li>
        <% }) %>
      </ul>
    <% } else if (setup && setup.recoveryCodes && setup.recoveryCodes.length) { %>
      <p><%= t('account.security.recovery.generatedForSetup') %></p>
      <ul class="security__recovery-list">
        <% setup.recoveryCodes.forEach(function (code) { %>
          <li><code class="security__code"><%= code %></code></li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted"><%= t('account.security.recovery.none') %></p>
    <% } %>
    <footer class="modal__actions">
      <a class="btn" href="/account/security/recovery-codes/download" download><%= t('account.security.common.download') %></a>
      <button type="button" class="btn link" data-modal-close><%= t('account.security.common.close') %></button>
    </footer>
  </article>
</dialog>

<dialog id="modal-regenerate-codes" class="modal">
  <form method="post" action="/account/security/recovery-codes" class="modal__content">
    <%- include('../partials/csrf_field') %>
    <h2><%= t('account.security.recovery.regenerateTitle') %></h2>
    <p><%= t('account.security.recovery.regenerateIntro') %></p>
    <div class="field">
      <label for="regen-token"><%= t('account.security.setup.form.totpLabel') %></label>
      <input
        id="regen-token"
        name="token"
        type="text"
        inputmode="numeric"
        autocomplete="one-time-code"
        maxlength="6"
        required
        placeholder="123456"
        title="<%= t('account.security.setup.form.codeTitle') %>"
      />
    </div>
    <div class="modal__actions">
      <button class="btn" data-icon="ðŸ”"><%= t('account.security.recovery.regenerate') %></button>
      <button type="button" class="btn link" data-modal-close><%= t('account.security.common.cancel') %></button>
    </div>
  </form>
</dialog>

<dialog id="modal-disable-twofactor" class="modal">
  <article class="modal__content">
    <h2><%= t('account.security.disable.title') %></h2>
    <p><%= t('account.security.disable.chooseMethod') %></p>
    <div class="security__modal-grid">
      <form method="post" action="/account/security/disable" class="security__form">
        <%- include('../partials/csrf_field') %>
        <input type="hidden" name="mode" value="totp" />
        <h3><%= t('account.security.disable.withTotp') %></h3>
        <div class="field">
          <label for="disable-token"><%= t('account.security.setup.form.totpLabel') %></label>
          <input
            id="disable-token"
            name="token"
            type="text"
            inputmode="numeric"
            autocomplete="one-time-code"
            maxlength="6"
            required
            placeholder="123456"
            title="<%= t('account.security.setup.form.codeTitle') %>"
          />
        </div>
        <div class="modal__actions">
          <button class="btn danger" data-icon="ðŸ›‘"><%= t('account.security.disable.confirm') %></button>
        </div>
      </form>
      <form method="post" action="/account/security/disable" class="security__form">
        <%- include('../partials/csrf_field') %>
        <input type="hidden" name="mode" value="recovery" />
        <h3><%= t('account.security.disable.withRecovery') %></h3>
        <div class="field">
          <label for="disable-recovery"><%= t('account.security.disable.recoveryLabel') %></label>
          <input
            id="disable-recovery"
            name="recoveryCode"
            type="text"
            required
            placeholder="EXEMPLE-12345"
          />
        </div>
        <div class="modal__actions">
          <button class="btn danger" data-icon="ðŸ›‘"><%= t('account.security.disable.confirm') %></button>
        </div>
      </form>
    </div>
    <footer class="modal__actions">
      <button type="button" class="btn link" data-modal-close><%= t('account.security.common.cancel') %></button>
    </footer>
  </article>
</dialog>

<script>
  (function () {
    function openModal(id) {
      if (!id) return;
      const dialog = document.getElementById(id);
      if (dialog && typeof dialog.showModal === 'function') {
        dialog.showModal();
      }
    }

    function closeModal(dialog) {
      if (dialog && typeof dialog.close === 'function') {
        dialog.close();
      }
    }

    document.addEventListener('click', (event) => {
      const openTrigger = event.target.closest('[data-modal-open]');
      if (openTrigger) {
        event.preventDefault();
        openModal(openTrigger.getAttribute('data-modal-open'));
        return;
      }
      const closeTrigger = event.target.closest('[data-modal-close]');
      if (closeTrigger) {
        event.preventDefault();
        closeModal(closeTrigger.closest('dialog'));
      }
    });

    document.addEventListener('cancel', (event) => {
      if (event.target instanceof HTMLDialogElement) {
        event.preventDefault();
        event.target.close();
      }
    });
  })();
</script>
