// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                    Int                     @id @default(autoincrement())
  username              String                  @unique
  passwordHash          String?
  displayName           String?
  avatar                String?
  bio                   String?
  email                 String?
  createdAt             DateTime                @default(now())
  lastLoginAt           DateTime?

  // Flags
  isAdmin               Boolean                 @default(false)
  isModerator           Boolean                 @default(false)
  isHelper              Boolean                 @default(false)
  isContributor         Boolean                 @default(false)
  isPremium             Boolean                 @default(false)
  premiumUntil          DateTime?

  // Permissions
  canCreatePages        Boolean                 @default(false)
  canEditOwnPages       Boolean                 @default(false)
  canEditAnyPage        Boolean                 @default(false)
  canPublishPages       Boolean                 @default(false)
  canDeletePages        Boolean                 @default(false)
  canManageTags         Boolean                 @default(false)
  canComment            Boolean                 @default(true)
  canApproveComments    Boolean                 @default(false)
  canDeleteComments     Boolean                 @default(false)
  canSubmitPages        Boolean                 @default(false)
  canViewSubmissions    Boolean                 @default(false)
  canApproveSubmissions Boolean                 @default(false)
  canBanIps             Boolean                 @default(false)
  canViewIpProfiles     Boolean                 @default(false)
  canManageUsers        Boolean                 @default(false)
  canManageRoles        Boolean                 @default(false)
  canManageBadges       Boolean                 @default(false)
  canViewStats          Boolean                 @default(false)
  canManageSettings     Boolean                 @default(false)
  canManageReactions    Boolean                 @default(false)
  canGeneratePremium    Boolean                 @default(false)
  canSchedulePages      Boolean                 @default(false)
  canViewTrash          Boolean                 @default(false)
  canManageUploads      Boolean                 @default(false)
  canViewEventLog       Boolean                 @default(false)

  // Ban info
  isBanned              Boolean                 @default(false)
  banReason             String?
  bannedAt              DateTime?

  // 2FA
  totpSecret            String?
  totpEnabled           Boolean                 @default(false)
  recoveryCodes         String?

  // Relations
  pages                 Page[]
  pageRevisions         PageRevision[]
  comments              Comment[]
  roleAssignments       UserRoleAssignment[]
  webauthnCredentials   WebAuthnCredential[]
  badges                UserBadge[]
  pageSubmissions       PageSubmission[]
  actionBans            UserActionBan[]
  banAppeals            BanAppeal[]
  premiumCodeRedemptions PremiumCode[]

  @@map("users")
}

model Role {
  id                    Int                     @id @default(autoincrement())
  name                  String                  @unique
  color                 String?
  hierarchy             Int                     @default(0)

  // Permissions (same as User)
  isAdmin               Boolean                 @default(false)
  isModerator           Boolean                 @default(false)
  isHelper              Boolean                 @default(false)
  isContributor         Boolean                 @default(false)
  canCreatePages        Boolean                 @default(false)
  canEditOwnPages       Boolean                 @default(false)
  canEditAnyPage        Boolean                 @default(false)
  canPublishPages       Boolean                 @default(false)
  canDeletePages        Boolean                 @default(false)
  canManageTags         Boolean                 @default(false)
  canComment            Boolean                 @default(true)
  canApproveComments    Boolean                 @default(false)
  canDeleteComments     Boolean                 @default(false)
  canSubmitPages        Boolean                 @default(false)
  canViewSubmissions    Boolean                 @default(false)
  canApproveSubmissions Boolean                 @default(false)
  canBanIps             Boolean                 @default(false)
  canViewIpProfiles     Boolean                 @default(false)
  canManageUsers        Boolean                 @default(false)
  canManageRoles        Boolean                 @default(false)
  canManageBadges       Boolean                 @default(false)
  canViewStats          Boolean                 @default(false)
  canManageSettings     Boolean                 @default(false)
  canManageReactions    Boolean                 @default(false)
  canGeneratePremium    Boolean                 @default(false)
  canSchedulePages      Boolean                 @default(false)
  canViewTrash          Boolean                 @default(false)
  canManageUploads      Boolean                 @default(false)
  canViewEventLog       Boolean                 @default(false)

  // Relations
  userAssignments       UserRoleAssignment[]
  pageVisibility        PageRoleVisibility[]

  @@map("roles")
}

model UserRoleAssignment {
  id                    Int                     @id @default(autoincrement())
  userId                Int
  roleId                Int
  assignedAt            DateTime                @default(now())

  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role                  Role                    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_role_assignments")
}

model WebAuthnCredential {
  id                    String                  @id
  userId                Int
  credentialId          String
  publicKey             String
  counter               Int                     @default(0)
  transports            String?
  createdAt             DateTime                @default(now())
  lastUsedAt            DateTime?
  name                  String?

  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_webauthn_credentials")
}

model Page {
  id                    Int                     @id @default(autoincrement())
  slug                  String                  @unique
  title                 String
  content               String
  authorId              Int
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  publishedAt           DateTime?
  scheduledAt           DateTime?
  status                String                  @default("draft") // draft, published, scheduled
  views                 Int                     @default(0)
  likes                 Int                     @default(0)

  author                User                    @relation(fields: [authorId], references: [id])
  revisions             PageRevision[]
  tags                  PageTag[]
  comments              Comment[]
  views_records         PageView[]
  viewsDaily            PageViewDaily[]
  reactions             PageReaction[]
  roleVisibility        PageRoleVisibility[]

  @@map("pages")
}

model PageRevision {
  id                    Int                     @id @default(autoincrement())
  pageId                Int
  revisionNumber        Int
  title                 String
  content               String
  authorId              Int
  createdAt             DateTime                @default(now())

  page                  Page                    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  author                User                    @relation(fields: [authorId], references: [id])

  @@unique([pageId, revisionNumber])
  @@map("page_revisions")
}

model Tag {
  id                    Int                     @id @default(autoincrement())
  name                  String                  @unique
  slug                  String                  @unique @default("")
  color                 String?

  pages                 PageTag[]

  @@map("tags")
}

model PageTag {
  id                    Int                     @id @default(autoincrement())
  pageId                Int
  tagId                 Int

  page                  Page                    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  tag                   Tag                     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([pageId, tagId])
  @@map("page_tags")
}

model PageRoleVisibility {
  id                    Int                     @id @default(autoincrement())
  pageId                Int
  roleId                Int

  page                  Page                    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  role                  Role                    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([pageId, roleId])
  @@map("page_role_visibility")
}

model PageView {
  id                    Int                     @id @default(autoincrement())
  pageId                Int
  ipHash                String
  userAgent             String?
  viewedAt              DateTime                @default(now())

  page                  Page                    @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@map("page_views")
}

model PageViewDaily {
  id                    Int                     @id @default(autoincrement())
  pageId                Int
  date                  DateTime
  views                 Int                     @default(0)

  page                  Page                    @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, date])
  @@map("page_view_daily")
}

model Comment {
  id                    String                  @id
  pageId                Int
  authorId              Int?
  authorName            String?
  authorIpHash          String?
  content               String
  parentId              String?
  status                String                  @default("pending") // pending, approved, rejected
  createdAt             DateTime                @default(now())
  updatedAt             DateTime?

  page                  Page                    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  author                User?                   @relation(fields: [authorId], references: [id], onDelete: SetNull)
  parent                Comment?                @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies               Comment[]               @relation("CommentReplies")
  attachments           CommentAttachment[]
  reactions             CommentReaction[]

  @@map("comments")
}

model CommentAttachment {
  id                    Int                     @id @default(autoincrement())
  commentId             String
  filename              String
  path                  String
  size                  Int
  mimeType              String
  uploadedAt            DateTime                @default(now())

  comment               Comment                 @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@map("comment_attachments")
}

model CommentReaction {
  id                    Int                     @id @default(autoincrement())
  commentId             String
  userId                Int?
  ipHash                String?
  reactionType          String
  createdAt             DateTime                @default(now())

  comment               Comment                 @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@map("comment_reactions")
}

model PageReaction {
  id                    Int                     @id @default(autoincrement())
  pageId                Int
  userId                Int?
  ipHash                String?
  reactionType          String
  createdAt             DateTime                @default(now())

  page                  Page                    @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, userId])
  @@unique([pageId, ipHash])
  @@map("page_reactions")
}

model ReactionOption {
  id                    Int                     @id @default(autoincrement())
  type                  String                  @unique
  emoji                 String?
  imageUrl              String?
  label                 String

  @@map("reaction_options")
}

model PageSubmission {
  id                    Int                     @id @default(autoincrement())
  title                 String
  content               String
  slug                  String?
  submitterId           Int
  pageId                Int?
  type                  String // create, edit
  status                String                  @default("pending") // pending, approved, rejected
  submittedAt           DateTime                @default(now())
  reviewedAt            DateTime?
  reviewNotes           String?

  submitter             User                    @relation(fields: [submitterId], references: [id])

  @@map("page_submissions")
}

model PremiumCode {
  id                    Int                     @id @default(autoincrement())
  code                  String                  @unique
  durationDays          Int
  redeemedBy            Int?
  redeemedAt            DateTime?
  createdAt             DateTime                @default(now())

  user                  User?                   @relation(fields: [redeemedBy], references: [id])

  @@map("premium_codes")
}

model IpBan {
  id                    Int                     @id @default(autoincrement())
  ipHash                String
  reason                String
  scope                 String                  @default("global") // global, action, tag
  scopeValue            String?
  bannedAt              DateTime                @default(now())
  expiresAt             DateTime?

  @@map("ip_bans")
}

model UserActionBan {
  id                    Int                     @id @default(autoincrement())
  userId                Int
  action                String
  reason                String
  bannedAt              DateTime                @default(now())
  expiresAt             DateTime?

  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_action_bans")
}

model BanAppeal {
  id                    Int                     @id @default(autoincrement())
  userId                Int
  reason                String
  status                String                  @default("pending") // pending, accepted, rejected
  submittedAt           DateTime                @default(now())
  reviewedAt            DateTime?
  reviewNotes           String?

  user                  User                    @relation(fields: [userId], references: [id])

  @@map("ban_appeals")
}

model IpProfile {
  id                    Int                     @id @default(autoincrement())
  ipHash                String                  @unique
  reputation            Int                     @default(0)
  lastSeen              DateTime                @default(now())
  claimedBy             Int?
  notes                 String?

  @@map("ip_profiles")
}

model Badge {
  id                    Int                     @id @default(autoincrement())
  name                  String                  @unique
  description           String?
  icon                  String?
  color                 String?

  users                 UserBadge[]

  @@map("badges")
}

model UserBadge {
  id                    Int                     @id @default(autoincrement())
  userId                Int
  badgeId               Int
  awardedAt             DateTime                @default(now())

  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge                 Badge                   @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Setting {
  id                    Int                     @id @default(autoincrement())
  key                   String                  @unique
  value                 String

  @@map("settings")
}

model EventLog {
  id                    Int                     @id @default(autoincrement())
  channel               String // admin, feed
  event                 String
  data                  String?
  createdAt             DateTime                @default(now())

  @@map("event_logs")
}

model Upload {
  id                    Int                     @id @default(autoincrement())
  filename              String
  path                  String
  size                  Int
  mimeType              String
  uploadedBy            Int?
  uploadedAt            DateTime                @default(now())

  @@map("uploads")
}

model DeletedPage {
  id                    Int                     @id @default(autoincrement())
  slug                  String
  title                 String
  content               String
  authorId              Int
  deletedAt             DateTime                @default(now())
  deletedBy             Int

  @@map("deleted_pages")
}
